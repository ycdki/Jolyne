<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Merry Christmas</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Times New Roman', serif; user-select: none; -webkit-touch-callout: none;}
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* å¯åŠ¨å±‚ (ä¸ºäº†è§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾éŸ³ä¹é™åˆ¶) */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        .start-btn {
            border: 1px solid #d4af37; color: #d4af37; padding: 15px 40px;
            background: transparent; font-size: 18px; letter-spacing: 4px;
            cursor: pointer; text-transform: uppercase; margin-top: 20px;
            transition: 0.3s;
        }
        .start-btn:hover { background: #d4af37; color: #000; box-shadow: 0 0 20px #d4af37; }

        /* UI */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; padding-top: 40px;
            opacity: 0; transition: opacity 2s ease;
        }
        h1 { 
            color: #fceea7; font-size: clamp(30px, 6vw, 56px); margin: 0; font-weight: 400; 
            letter-spacing: 6px; text-shadow: 0 0 30px rgba(252, 238, 167, 0.6); 
            font-family: 'Times New Roman', serif; text-align: center;
        }
        .music-control {
            margin-top: 20px; pointer-events: auto; color: rgba(212, 175, 55, 0.7);
            font-size: 12px; cursor: pointer; border: 1px solid rgba(212, 175, 55, 0.3);
            padding: 5px 15px; border-radius: 20px;
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥ */
        #file-input { display: none; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="start-overlay">
        <div style="color: #d4af37; letter-spacing: 2px; margin-bottom: 20px;">A GIFT FOR YOU</div>
        <button class="start-btn" id="btn-enter">OPEN</button>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer">
        <h1 id="title-text">Merry Christmas</h1>
        <div class="music-control" id="music-btn">ğŸµ Music: ON</div>
    </div>

    <audio id="bgm" loop>
        <source src="" type="audio/mp3"> 
    </audio>
    <audio id="sfx-magic">
        <source src="https://assets.mixkit.co/active_storage/sfx/2048/2048-preview.mp3" type="audio/mp3">
    </audio>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- 1. è‡ªå®šä¹‰é…ç½®åŒºåŸŸ (åœ¨è¿™é‡Œä¿®æ”¹å›¾ç‰‡å’Œæ–‡å­—) ---
        const CUSTOM_CONFIG = {
            // åœ¨è¿™é‡Œå¡«å…¥ä½ æœ‹å‹çš„ç…§ç‰‡é“¾æ¥ (å¯ä»¥æ˜¯æœ¬åœ°è·¯å¾„ 'photo1.jpg' æˆ–ç½‘ç»œé“¾æ¥)
            // å»ºè®®å›¾ç‰‡æ¯”ä¾‹ 1:1ï¼Œå¦‚æœä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤æ–‡å­—å¡ç‰‡
            photos: [
                // "https://images.unsplash.com/photo-1512917774080-9991f1c4c750?auto=format&fit=crop&w=500&q=60",
                // "https://images.unsplash.com/photo-1543258103-a62bdc069871?auto=format&fit=crop&w=500&q=60",
            ],
            // ä½ çš„ç¥ç¦è¯­æ ‡é¢˜
            title: "Merry Christmas",
            // éŸ³ä¹æ–‡ä»¶è·¯å¾„ (è¯·ä¿®æ”¹è¿™é‡Œ)
            musicUrl: "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3?filename=christmas-magic-126462.mp3", 
        };

        const CONFIG = {
            colors: { bg: 0x000000, gold: 0xffd966, green: 0x03180a, red: 0x990000 },
            particles: { 
                count: 1200, // å‡å°‘æ€»æ•°ä»¥ä¼˜åŒ–ç§»åŠ¨ç«¯
                dustCount: 1000, 
                treeHeight: 22, 
                treeRadius: 7.5 
            }
        };

        let scene, camera, renderer, composer, controls;
        let clock = new THREE.Clock();
        
        // ä¼˜åŒ–æ ¸å¿ƒï¼šä½¿ç”¨ InstancedMesh
        let particleMesh, dustMesh; 
        const dummy = new THREE.Object3D();
        
        // æ•°æ®å­˜å‚¨
        let particlesData = []; // å­˜å‚¨ä½ç½®ã€é€Ÿåº¦ç­‰ä¿¡æ¯
        let photoObjects = [];  // ç…§ç‰‡å•ç‹¬å¤„ç†ï¼Œå› ä¸ºæ•°é‡å°‘ä¸”éœ€è¦ç‰¹æ®Šèšç„¦åŠ¨ç”»
        
        // çŠ¶æ€
        let isStarted = false;
        let time = 0;
        let isMusicPlaying = false;

        // --- åˆå§‹åŒ– ---
        function init() {
            // 1. è®¾ç½® DOM
            document.getElementById('title-text').innerText = CUSTOM_CONFIG.title;
            document.getElementById('bgm').src = CUSTOM_CONFIG.musicUrl;
            
            // 2. ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('btn-enter').addEventListener('click', startExperience);
            document.getElementById('music-btn').addEventListener('click', toggleMusic);

            initThree();
            initInstancedParticles();
            initPhotos();
            setupPostProcessing();
            
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function startExperience() {
            const overlay = document.getElementById('start-overlay');
            overlay.style.opacity = 0;
            setTimeout(() => overlay.remove(), 1000);
            
            document.getElementById('ui-layer').style.opacity = 1;
            
            // æ’­æ”¾éŸ³ä¹
            const bgm = document.getElementById('bgm');
            const sfx = document.getElementById('sfx-magic');
            bgm.volume = 0.5;
            bgm.play().then(() => {
                isMusicPlaying = true;
            }).catch(e => console.log("Audio autoplay blocked", e));
            
            sfx.volume = 0.4;
            sfx.play();
            
            isStarted = true;
        }

        function toggleMusic() {
            const bgm = document.getElementById('bgm');
            const btn = document.getElementById('music-btn');
            if(bgm.paused) {
                bgm.play();
                btn.innerText = "ğŸµ Music: ON";
            } else {
                bgm.pause();
                btn.innerText = "ğŸµ Music: OFF";
            }
        }

        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.background = new THREE.Color(CONFIG.colors.bg);
            scene.fog = new THREE.FogExp2(CONFIG.colors.bg, 0.02);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 5, 40);

            renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);

            // ç®€å•çš„äº¤äº’æ§åˆ¶
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;
            controls.maxDistance = 60;
            controls.minDistance = 10;

            // ç¯å…‰
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            const point = new THREE.PointLight(0xffaa00, 2, 50);
            point.position.set(0, 10, 0);
            scene.add(point);
        }

        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šå®ä¾‹åŒ–ç²’å­ ---
        function initInstancedParticles() {
            // 1. è£…é¥°çƒ (Ornaments)
            const geometry = new THREE.SphereGeometry(0.3, 16, 16); // é™ä½å‡ ä½•ç²¾åº¦
            const material = new THREE.MeshStandardMaterial({
                color: CONFIG.colors.gold,
                metalness: 0.9,
                roughness: 0.1,
                emissive: 0x221100
            });

            particleMesh = new THREE.InstancedMesh(geometry, material, CONFIG.particles.count);
            scene.add(particleMesh);

            // 2. å°˜åŸƒ (Dust)
            const dustGeo = new THREE.TetrahedronGeometry(0.15, 0); // æç®€å‡ ä½•ä½“
            const dustMat = new THREE.MeshBasicMaterial({ color: 0xffffaa, transparent: true, opacity: 0.6 });
            dustMesh = new THREE.InstancedMesh(dustGeo, dustMat, CONFIG.particles.dustCount);
            scene.add(dustMesh);

            // 3. è®¡ç®—æ‰€æœ‰ä½ç½®æ•°æ®
            for (let i = 0; i < CONFIG.particles.count; i++) {
                // æ ‘å½¢èºæ—‹ç®—æ³•
                const h = CONFIG.particles.treeHeight;
                let t = Math.random(); 
                t = Math.pow(t, 0.8); // èšé›†åœ¨åº•éƒ¨
                const y = (t * h) - (h/2);
                const r = (1 - t) * CONFIG.particles.treeRadius * (0.8 + Math.random()*0.4);
                const angle = t * 25 * Math.PI + Math.random() * Math.PI; // èºæ—‹åœˆæ•°

                particlesData.push({
                    x: Math.cos(angle) * r,
                    y: y,
                    z: Math.sin(angle) * r,
                    speed: 0.5 + Math.random() * 1.5,
                    offset: Math.random() * 100,
                    type: 'TREE'
                });
            }

            for (let i = 0; i < CONFIG.particles.dustCount; i++) {
                particlesData.push({
                    x: (Math.random()-0.5) * 40,
                    y: (Math.random()-0.5) * 40,
                    z: (Math.random()-0.5) * 40,
                    speed: 0.2,
                    offset: Math.random() * 100,
                    type: 'DUST'
                });
            }
        }

        // --- ç…§ç‰‡å¤„ç† ---
        function initPhotos() {
            const photoGroup = new THREE.Group();
            scene.add(photoGroup);

            const loader = new THREE.TextureLoader();
            const list = CUSTOM_CONFIG.photos.length > 0 ? CUSTOM_CONFIG.photos : ['default'];

            list.forEach((url, index) => {
                const group = new THREE.Group();
                
                // é‡‘è‰²è¾¹æ¡†
                const frameGeo = new THREE.BoxGeometry(2.2, 2.7, 0.1);
                const frameMat = new THREE.MeshStandardMaterial({ color: CONFIG.colors.gold, metalness: 1.0, roughness: 0.2 });
                const frame = new THREE.Mesh(frameGeo, frameMat);
                group.add(frame);

                // ç…§ç‰‡é¢
                const photoGeo = new THREE.PlaneGeometry(2, 2.5);
                let photoMat;
                
                if (url === 'default') {
                    // é»˜è®¤æ–‡å­—è´´å›¾
                    const canvas = document.createElement('canvas');
                    canvas.width = 512; canvas.height = 640;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#111'; ctx.fillRect(0,0,512,640);
                    ctx.fillStyle = '#d4af37'; ctx.font = '60px Serif'; ctx.textAlign='center';
                    ctx.fillText("BEST", 256, 280);
                    ctx.fillText("WISHES", 256, 360);
                    const tex = new THREE.CanvasTexture(canvas);
                    photoMat = new THREE.MeshBasicMaterial({ map: tex });
                } else {
                    loader.load(url, (tex) => {
                        tex.colorSpace = THREE.SRGBColorSpace;
                        photoMesh.material.map = tex;
                        photoMesh.material.needsUpdate = true;
                    });
                    photoMat = new THREE.MeshBasicMaterial({ color: 0xffffff }); // å…ˆç™½æ¿ï¼ŒåŠ è½½å®Œæ˜¾ç¤º
                }
                
                const photoMesh = new THREE.Mesh(photoGeo, photoMat);
                photoMesh.position.z = 0.06;
                group.add(photoMesh);

                // åˆ†æ•£åœ¨æ ‘çš„å‘¨å›´
                const angle = (index / list.length) * Math.PI * 2;
                const radius = 6;
                group.position.set(Math.cos(angle)*radius, (index - list.length/2)*1.5, Math.sin(angle)*radius);
                
                // è®©ç…§ç‰‡éšæœºæ¼‚æµ®ä¸€ç‚¹
                group.userData = {
                    baseY: group.position.y,
                    speed: 0.5 + Math.random() * 0.5,
                    offset: Math.random() * 10
                };

                photoGroup.add(group);
                photoObjects.push(group);
            });
        }

        function setupPostProcessing() {
            const renderScene = new RenderPass(scene, camera);
            
            // Bloom å‚æ•°è°ƒä¼˜ï¼šå‡å°‘åˆ†è¾¨ç‡æ¶ˆè€—ï¼Œå¢åŠ é˜ˆå€¼é˜²æ­¢å…¨å±è¿‡æ›
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.6;
            bloomPass.strength = 0.6; // ç¨å¾®é™ä½å¼ºåº¦
            bloomPass.radius = 0.5;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            time += dt;

            controls.update();

            // 1. æ›´æ–° InstancedMesh (è£…é¥°çƒ)
            let particleIdx = 0;
            for (let i = 0; i < CONFIG.particles.count; i++) {
                const data = particlesData[i];
                // ç®€å•çš„ä¸Šä¸‹æµ®åŠ¨æ•ˆæœ
                const y = data.y + Math.sin(time * data.speed + data.offset) * 0.2;
                
                dummy.position.set(data.x, y, data.z);
                
                // è®©çƒä½“è‡ªè½¬
                dummy.rotation.x = time * data.speed;
                dummy.rotation.y = time * data.speed;
                
                const scale = 1.0 + Math.sin(time * 2 + data.offset) * 0.2; // å‘¼å¸æ•ˆæœ
                dummy.scale.set(scale, scale, scale);

                dummy.updateMatrix();
                particleMesh.setMatrixAt(i, dummy.matrix);
            }
            particleMesh.instanceMatrix.needsUpdate = true;

            // 2. æ›´æ–° Dust
            let dustBaseIdx = CONFIG.particles.count;
            for (let i = 0; i < CONFIG.particles.dustCount; i++) {
                const data = particlesData[dustBaseIdx + i]; // æ³¨æ„ç´¢å¼•åç§»
                
                // å°˜åŸƒé£˜åŠ¨
                if (!data) continue;
                let dy = data.y - dt * 0.5; // ç¼“ç¼“ä¸‹è½
                if (dy < -20) dy = 20; // å¾ªç¯
                data.y = dy;

                dummy.position.set(data.x, data.y, data.z);
                dummy.rotation.set(time, time, time);
                dummy.scale.setScalar(0.5);
                
                dummy.updateMatrix();
                dustMesh.setMatrixAt(i, dummy.matrix);
            }
            dustMesh.instanceMatrix.needsUpdate = true;

            // 3. æ›´æ–°ç…§ç‰‡
            photoObjects.forEach(group => {
                group.position.y = group.userData.baseY + Math.sin(time * group.userData.speed + group.userData.offset) * 0.5;
                group.rotation.y += 0.005; // ç¼“æ…¢è‡ªè½¬å±•ç¤º
                group.lookAt(camera.position); // ä¹Ÿå¯ä»¥é€‰æ‹©è®©å®ƒä»¬å§‹ç»ˆé¢å‘ç›¸æœº
            });

            composer.render();
        }

        init();
    </script>
</body>
</html>
